<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>舆情标签自动化分类智能体</title>
  <style>
    /* 全局重置与基础样式 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Helvetica Neue", Arial, sans-serif; background: #f4f6f8; color: #333; line-height: 1.6; }
    a { color: inherit; text-decoration: none; }

    .container { width: 100%; margin: 0 auto; padding-bottom: 40px; }
    header.top-nav { width: 100%; background: #fff; border-bottom: 1px solid #e1e4e8; padding: 16px 40px; display: flex; align-items: center; }
    header.top-nav .logo { width: 36px; height: 36px; background: #409eff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; }
    header.top-nav h2 { font-size: 1.5rem; margin-left: 12px; }

    .hero { background: #409eff; color: #fff; padding: 80px 40px; text-align: center; border-radius: 0 0 8px 8px; }
    .hero h1 { font-size: 2.5rem; margin-bottom: 16px; }
    .hero p { font-size: 1.1rem; margin-bottom: 24px; }
    .hero .pill-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 16px; }
    .hero .pill { background: rgba(255,255,255,0.15); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: .95rem; display: flex; align-items: center; gap: 8px; cursor: default; }
    .hero .pill:hover { background: rgba(255,255,255,0.25); }

    .instruction-section { background: #fff; width: 80%; margin: 40px auto; padding: 32px 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .instruction-section h2 { font-size: 1.75rem; margin-bottom: 8px; text-align: center; }
    .instruction-section p.subtitle { font-size: 1rem; color: #666; text-align: center; margin-bottom: 24px; }
    .instruction-section .field { margin-bottom: 24px; position: relative; }
    .instruction-section label { display: block; font-weight: 600; margin-bottom: 8px; }
    .instruction-section input, .instruction-section textarea { width: 100%; padding: 12px 14px; border: 1px solid #d1d9e0; border-radius: 6px; background: #fafbfc; font-size: 1rem; }
    .instruction-section textarea { resize: vertical; min-height: 100px; }
    .instruction-section input:focus, .instruction-section textarea:focus { border-color: #409eff; background: #fff; outline: none; }

    .copy-btn { position: absolute; top: 8px; right: 8px; background: #409eff; color: #fff; border: none; border-radius: 4px; padding: 4px 10px; font-size: .85rem; cursor: pointer; }
    .copy-btn:hover { background: #357cd2; }

    #runBtn { padding: 12px 28px; font-size: 1rem; background: #409eff; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    #runBtn:disabled { background: #a0bcd8; cursor: not-allowed; }

    #output { margin: 32px auto; width: 90%; max-height: 60vh; overflow-y: auto; background: #fafbfc; border-top: 1px solid #d1d9e0; border-bottom: 1px solid #d1d9e0; border-radius: 0 0 6px 6px; display: none; }
    #output .inner { padding: 0 20px; }

    .markdown-wrapper { overflow-x: auto; margin: 16px 0 32px; }
    .markdown-wrapper table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    .markdown-wrapper th, .markdown-wrapper td { border: 1px solid #d1d9e0; padding: 8px; text-align: left; }
    .markdown-wrapper th:first-child, .markdown-wrapper td:first-child { width: 30%; }
    .markdown-wrapper th:nth-child(n+2), .markdown-wrapper td:nth-child(n+2) { width: 17%; }

    .action-buttons { margin: 16px 0; display: none; gap: 12px; }
    .action-buttons button { padding: 8px 16px; font-size: .95rem; border: none; border-radius: 4px; cursor: pointer; }
    .copy-md { background: #409eff; color: #fff; }
    .export-excel { background: #67c23a; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <header class="top-nav">
      <div class="logo">AI</div><h2>舆情标签自动化分类智能体</h2>
    </header>

    <section class="hero">
      <h1>舆情标签自动化分类</h1>
      <p>上传 Excel，AI 打标签并展示结果</p>
    </section>

    <section class="instruction-section">
      <h2>开始分类</h2>
      <p class="subtitle">请上传包含“摘要”列的 .xlsx 文件并填写指令</p>

      <div class="field">
        <label>用户指令示例：</label>
        <div style="position:relative;background:#f1f3f5;padding:12px 16px;border-left:4px solid #409eff;border-radius:4px;">
          <pre id="exampleText">按照四个方面对“摘要”打标签：
1. 产品口味评价：好评、中评、差评
2. 环境和服务评价：好评、中评、差评
3. 品牌及股票资讯：是、否
4. 品牌营销宣传：是、否</pre>
          <button class="copy-btn" id="copyExampleBtn">复制示例</button>
        </div>
      </div>

      <div class="field">
        <label for="fileInput">上传 .xlsx 文件</label>
        <input type="file" id="fileInput" accept=".xlsx" />
      </div>

      <div class="field">
        <label for="instructionInput">用户指令</label>
        <textarea id="instructionInput" placeholder="请在此输入指令"></textarea>
      </div>

      <button id="runBtn">执行</button>

      <div class="action-buttons" id="actions">
        <button class="copy-md" id="copyMarkdownBtn">复制 Markdown</button>
        <button class="export-excel" id="downloadExcelBtn">下载 Excel</button>
      </div>

      <div id="output"><div class="inner"></div></div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    let latestMarkdown = "";

    document.getElementById('copyExampleBtn').addEventListener('click', () => {
      const txt = document.getElementById('exampleText').innerText.trim();
      navigator.clipboard.writeText(txt);
      document.getElementById('instructionInput').value = txt;
      alert('示例已复制');
    });

    const runBtn = document.getElementById('runBtn');
    const copyBtn = document.getElementById('copyMarkdownBtn');
    const exportBtn = document.getElementById('downloadExcelBtn');
    const actions = document.getElementById('actions');
    const output = document.getElementById('output');
    const outputInner = document.querySelector('#output .inner');

    runBtn.addEventListener('click', async () => {
      runBtn.disabled = true;
      runBtn.textContent = '处理中…';
      actions.style.display = 'none';
      outputInner.innerHTML = '';
      output.style.display = 'none';

      try {
        // 1. 读取文件
        const file = document.getElementById('fileInput').files[0];
        if (!file) throw new Error('请先上传 Excel 文件');
        const reader = new FileReader();
        const arrayBuffer = await new Promise((res, rej) => {
          reader.onload = e => res(e.target.result);
          reader.onerror = e => rej(e);
          reader.readAsArrayBuffer(file);
        });

        // 2. 解析表格
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const jsonArr = XLSX.utils.sheet_to_json(ws, { defval: '' });
        if (!jsonArr.length) throw new Error('Excel 中无数据行');

        // 3. 找到摘要列
        const keys = Object.keys(jsonArr[0]);
        const summaryKey = keys.find(k => k.trim() === '摘要');
        if (!summaryKey) throw new Error('未找到 “摘要” 列');

        // 4. 提取摘要并分组（每组50条）
        const summaries = jsonArr.map(r => String(r[summaryKey] || ''));
        const groups = [];
        for (let i = 0; i < summaries.length; i += 50) {
          groups.push(summaries.slice(i, i + 50));
        }

        // 5. 上传给 kofei.cc
        const userId = crypto.randomUUID ? crypto.randomUUID() : 'user_' + Date.now();
        const payload = {
          inputs: {
            row_grouped: JSON.stringify(groups),
            user_instruction: document.getElementById('instructionInput').value.trim(),
            language: ''
          },
          response_mode: 'blocking',
          user: userId
        };
        const res = await fetch('https://www.kofei.cc/v1/workflows/run', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer app-yTXPrjWxjb8iHKmu53K8akM4',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        if (!res.ok) throw new Error(text);
        const data = JSON.parse(text);

        // 6. 拿 Markdown
        let md = '';
        if (data.data?.outputs?.text) {
          md = Array.isArray(data.data.outputs.text)
            ? data.data.outputs.text.join('\n\n')
            : data.data.outputs.text;
        } else if (data.data?.result) {
          md = Array.isArray(data.data.result)
            ? data.data.result.join('\n\n')
            : data.data.result;
        }
        latestMarkdown = md;

        // 7. 渲染
        outputInner.innerHTML = `
          <h3>摘要 + 四个标签：</h3>
          <div class="markdown-wrapper">
            ${marked.parse(md)}
          </div>
        `;
        output.style.display = 'block';
        actions.style.display = 'flex';
        runBtn.textContent = '执行完成';
      } catch (e) {
        outputInner.innerHTML = `<pre style="color:red;">${e.message}</pre>`;
        output.style.display = 'block';
        runBtn.textContent = '执行失败';
      } finally {
        runBtn.disabled = false;
        setTimeout(() => runBtn.textContent = '执行', 1500);
      }
    });

    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(latestMarkdown).then(() => {
        alert('已复制完整 Markdown');
      });
    });

    exportBtn.addEventListener('click', () => {
      const tableEl = document.querySelector('.markdown-wrapper table');
      if (!tableEl) return alert('表格不存在');
      const wb = XLSX.utils.table_to_book(tableEl, { sheet: '标签结果' });
      XLSX.writeFile(wb, '标签结果.xlsx');
    });
  </script>
</body>
</html>
